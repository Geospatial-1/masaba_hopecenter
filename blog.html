<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masaba Hope Center News</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.0/dist/emoji-picker-element.min.css">
    <style>
        body {
            font-family: 'Inter', 'Lato', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }
        .navbar {
            background-color: #28a745;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .navbar-brand {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }
        .navbar-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .navbar-links a, .login-btn {
            background: white;
            color: #007bff;
            font-size: 1rem;
            font-weight: bold;
            padding: 8px 14px;
            border-radius: 4px;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .navbar-links a:hover, .login-btn:hover {
            background-color: #ffc107;
            color: #0056b3;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 32px 0 24px 0;
            text-align: center;
        }
        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin: 0;
        }
        .header p {
            font-size: 1.15rem;
            margin: 10px 0 0;
        }
        .container {
            max-width: 1100px;
            margin: 20px auto;
            padding: 0 12px;
        }
        .feature-section {
            background: #fffbe6;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 24px 18px;
            margin-bottom: 32px;
            box-shadow: 0 4px 18px rgba(255,193,7,0.08);
        }
        .feature-section h2 {
            color: #d9534f;
            font-family: 'Playfair Display', serif;
            margin-top: 0;
        }
        .feature-section .post-meta {
            color: #888;
            font-size: 1rem;
        }
        .feature-section .feature-body {
            font-size: 1.15rem;
            color: #333;
            margin-top: 10px;
        }
        .expand-btn {
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 8px 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 18px auto 0 auto;
            display: block;
            transition: background 0.2s;
        }
        .expand-btn:hover {
            background: #0056b3;
        }
        .post-card {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
        }
        .post-card:hover {
            transform: scale(1.01);
            box-shadow: 0 6px 16px rgba(0,0,0,0.13);
        }
        .post-card img {
            width: 100%;
            height: 220px;
            object-fit: cover;
        }
        .post-content {
            padding: 18px;
        }
        .post-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #d9534f;
            margin: 0 0 8px 0;
            font-family: 'Playfair Display', serif;
        }
        .post-meta {
            font-size: 0.95rem;
            color: #888;
            margin-bottom: 10px;
        }
        .post-highlight {
            font-size: 1.08rem;
            color: #333;
            line-height: 1.7;
        }
        .archive-label {
            color: #ffc107;
            font-weight: bold;
            margin-top: 8px;
        }
        .likes-share-row {
            display: flex;
            align-items: center;
            gap: 18px;
            margin-top: 10px;
        }
        .like-btn, .share-btn, .copy-link-btn {
            background: #f6f6f6;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .like-btn.liked {
            background: #ffc107;
            color: #d9534f;
            border-color: #ffc107;
        }
        .like-btn:hover, .share-btn:hover, .copy-link-btn:hover {
            background: #e3e3e3;
        }
        /* Full Post Modal */
        .full-post-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
        }
        .full-post-content {
            background: #fff;
            border-radius: 10px;
            max-width: 700px;
            width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px 20px 20px 20px;
            position: relative;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
        }
        .full-post-content img {
            width: 100%;
            max-height: 320px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 18px;
        }
        .full-post-title {
            font-size: 2rem;
            font-family: 'Playfair Display', serif;
            color: #d9534f;
            margin-bottom: 8px;
        }
        .full-post-meta {
            font-size: 1rem;
            color: #888;
            margin-bottom: 18px;
        }
        .full-post-body {
            font-size: 1.13rem;
            color: #222;
            line-height: 2;
            margin-bottom: 24px;
        }
        .full-post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .full-post-actions button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 8px;
        }
        .full-post-actions button:hover {
            background: #0056b3;
        }
        .exit-btn {
            position: absolute;
            top: 12px;
            right: 18px;
            background: #d9534f;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
        }
        .exit-btn:hover {
            background: #b52b1b;
        }
        /* Comments Section */
        .comments-section {
            margin-top: 30px;
            background: #f6f6f6;
            border-radius: 8px;
            padding: 18px 12px;
        }
        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 18px;
        }
        .comment-form input, .comment-form textarea {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .comment-form button {
            align-self: flex-end;
            background: #28a745;
            color: white;
            border: none;
            padding: 7px 18px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }
        .comment-form button:hover {
            background: #218838;
        }
        .emoji-btn {
            background: #fffbe6;
            border: 1px solid #ffc107;
            border-radius: 4px;
            font-size: 1.3rem;
            cursor: pointer;
            margin-left: 4px;
        }
        .comment-list {
            margin-top: 10px;
        }
        .comment {
            background: linear-gradient(90deg, #e3ffe6 0%, #f6f6f6 100%);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 10px;
            border: 1px solid #b2e6c7;
            position: relative;
        }
        .comment-author {
            font-weight: bold;
            color: #007bff;
        }
        .comment-date {
            font-size: 0.9rem;
            color: #888;
            margin-left: 8px;
        }
        .comment-body {
            margin: 6px 0 0 0;
            font-size: 1.08rem;
            word-break: break-word;
        }
        .comment-actions {
            margin-top: 4px;
            display: flex;
            gap: 10px;
        }
        .comment-actions button {
            background: none;
            color: #d9534f;
            border: none;
            font-size: 0.95rem;
            cursor: pointer;
            padding: 0;
        }
        .comment-actions button.reply-btn {
            color: #007bff;
        }
        .comment-actions button.edit-btn {
            color: #28a745;
        }
        .comment-actions button.flag-btn {
            color: #ffc107;
        }
        .flagged {
            background: #fff3cd !important;
            border-color: #ffeeba !important;
        }
        .reply-list {
            margin-left: 24px;
            margin-top: 6px;
        }
        .hidden { display: none !important; }
        /* Login Modal */
        .login-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .login-modal-content {
            background: #fff;
            border-radius: 10px;
            padding: 32px 24px;
            max-width: 350px;
            width: 95vw;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .login-modal-content h2 {
            font-family: 'Playfair Display', serif;
            color: #007bff;
            margin-bottom: 10px;
        }
        .login-modal-content input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .login-modal-content button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }
        .login-modal-content button:hover {
            background: #0056b3;
        }
        /* Draft Modal */
        .draft-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .draft-modal-content {
            background: #fff;
            border-radius: 10px;
            padding: 32px 24px;
            max-width: 500px;
            width: 95vw;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .draft-modal-content h2 {
            font-family: 'Playfair Display', serif;
            color: #28a745;
            margin-bottom: 10px;
        }
        .draft-modal-content label {
            font-weight: bold;
            margin-top: 8px;
        }
        .draft-modal-content input[type="text"],
        .draft-modal-content input[type="file"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .draft-modal-content .editor-toolbar {
            margin: 8px 0;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .draft-modal-content .editor-toolbar button {
            background: #f6f6f6;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 1rem;
            cursor: pointer;
        }
        .draft-modal-content .editor-toolbar button:hover {
            background: #ffc107;
        }
        .draft-modal-content .editor {
            min-height: 100px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            font-size: 1rem;
            background: #f9f9f9;
        }
        .draft-modal-content button[type="submit"] {
            background: #28a745;
            color: white;
            margin-top: 10px;
        }
        .draft-modal-content button[type="submit"]:hover {
            background: #218838;
        }
        .post-list {
            margin-top: 18px;
        }
        .post-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f6f6f6;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 8px;
        }
        .post-item .post-title {
            font-weight: bold;
            color: #007bff;
        }
        .post-item .delete-btn {
            background: #d9534f;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 0.95rem;
            cursor: pointer;
        }
        .post-item .delete-btn:hover {
            background: #b52b1b;
        }
        @media (max-width: 700px) {
            .header h1 { font-size: 1.4rem; }
            .post-card img, .full-post-content img { height: 160px; }
            .full-post-content { padding: 12px 4vw 12px 4vw; }
        }
        @media (max-width: 500px) {
            .container { padding: 0 2vw; }
            .post-card .post-title, .full-post-title { font-size: 1.1rem; }
        }
        /* Add/extend styles for modals, dashboard, chat, badges, overlays */
        .recruit-btn {
            background: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 18px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
        }
        .recruit-btn:hover { background: #218838; }
        .recruit-modal, .dashboard-modal {
            display: none;
            position: fixed;
            z-index: 4000;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .recruit-modal-content, .dashboard-modal-content {
            background: #fff;
            border-radius: 10px;
            padding: 32px 24px;
            max-width: 400px;
            width: 95vw;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .dashboard-modal-content {
            max-width: 700px;
            width: 98vw;
            min-height: 60vh;
        }
        .blur-overlay {
            position: fixed;
            z-index: 5000;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(255,0,0,0.15);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .paused-warning {
            background: #fff;
            border: 2px solid #d9534f;
            color: #d9534f;
            padding: 24px 32px;
            border-radius: 10px;
            font-size: 1.2rem;
            margin-bottom: 18px;
            text-align: center;
        }
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            color: #fff;
            margin-left: 10px;
        }
        .status-active { background: #28a745; }
        .status-paused { background: #d9534f; }
        .chat-list { max-height: 250px; overflow-y: auto; margin-bottom: 10px; }
        .chat-badge {
            background: #28a745;
            color: #fff;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 0.9rem;
            margin-left: 4px;
        }
        .chat-messages {
            background: #e6f7ff;
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .chat-bubble {
            max-width: 70%;
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 1rem;
            display: inline-block;
            clear: both;
        }
        .chat-bubble.me {
            background: #28a745;
            color: #fff;
            align-self: flex-end;
            float: right;
        }
        .chat-bubble.them {
            background: #fff;
            color: #222;
            border: 1px solid #b2e6c7;
            float: left;
        }
        .chat-input-row {
            display: flex;
            gap: 8px;
        }
        .chat-input-row input, .chat-input-row textarea {
            flex: 1;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .chat-input-row button {
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 14px;
            font-weight: bold;
            cursor: pointer;
        }
        .chat-input-row button:hover { background: #0056b3; }
        @media (max-width: 700px) {
            .dashboard-modal-content { padding: 10px 2vw; }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <span class="navbar-brand">Masaba Hope Center Blog</span>
        <div class="navbar-links">
            <a href="index.html">Home</a>
            <a href="about.html">About</a>
            <a href="programs.html">Programs</a>
            <a href="donate.html">Donate</a>
            <a href="blog.html">Updates</a>
            <a href="contact.html">Contact</a>
            <button class="login-btn" id="loginBtn" onclick="openLoginModal()">User Login</button>
            <button class="login-btn" id="logoutBtn" onclick="logout()" style="display:none;">Logout</button>
            <button class="login-btn" id="dashboardBtn" onclick="openDashboardModal()" style="display:none;">Dashboard</button>
        </div>
    </nav>

    <!-- Blog Header -->
    <header class="header">
        <h1>Masaba News Updates</h1>
        <p>Stay updated with the latest news and stories</p>
    </header>

    <!-- Feature Post Section -->
    <div class="container" id="featureSection"></div>

    <!-- Blog Posts -->
    <div class="container" id="postsContainer"></div>
    <button class="expand-btn" id="expandOtherStoriesBtn" style="display:none;" onclick="expandOtherStories()">Show More Stories</button>

    <!-- Login Modal (with Recruitment Tab) -->
    <div class="login-modal" id="loginModal">
        <div class="login-modal-content">
            <div style="display:flex;gap:10px;margin-bottom:10px;">
                <button id="loginTabBtn" onclick="showLoginTab()" style="flex:1;">Login</button>
                <button id="recruitTabBtn" onclick="showRecruitTab()" style="flex:1;">Become an Author</button>
            </div>
            <div id="loginTab">
                <h2>User Login</h2>
                <input type="email" id="loginEmail" placeholder="Email" autocomplete="username" required>
                <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" required>
                <button onclick="login()">Login</button>
                <div id="loginError" style="color:#d9534f;margin-top:8px;"></div>
            </div>
            <div id="recruitTab" style="display:none;">
                <h2>Become an Author</h2>
                <form id="recruitForm" autocomplete="off">
                    <input type="text" id="recruitName" placeholder="Full Name" required>
                    <input type="email" id="recruitEmail" placeholder="Email" required>
                    <input type="tel" id="recruitPhone" placeholder="Phone" required>
                    <input type="text" id="recruitArea" placeholder="Area of Residence" required>
                    <input type="text" id="recruitOccupation" placeholder="Occupation" required>
                    <textarea id="recruitReason" placeholder="Why do you want to join?" required></textarea>
                    <label><input type="checkbox" id="recruitFree" required> I agree to work for free without pay</label>
                    <label><input type="checkbox" id="recruitSecret" required> I will keep my account secret and not share it</label>
                    <button type="submit">Submit Application</button>
                </form>
                <div id="recruitMsg" style="color:#28a745;margin-top:8px;"></div>
            </div>
        </div>
    </div>

    <!-- Draft Modal -->
    <div class="draft-modal" id="draftModal">
        <div class="draft-modal-content" style="max-height:90vh;overflow-y:auto;">
            <h2>Create/Edit Post</h2>
            <form id="postForm" autocomplete="off">
                <label>Title</label>
                <input type="text" id="draftTitle" required>
                <label>Image</label>
                <input type="file" id="draftImage" accept="image/*">
                <label>Body</label>
                <div id="draftBody" class="editor" contenteditable="true" style="min-height:160px;max-height:400px;overflow-y:auto;"></div>
                <label><input type="checkbox" id="featurePost"> Feature this post</label>
                <button type="submit" id="saveDraftBtn" style="margin-top:10px;">Save Draft</button>
                <button type="button" id="publishPostBtn" style="margin-top:10px;background:#007bff;">Publish Post</button>
            </form>
            <div class="post-list" id="draftPostList">
                <h4 style="margin-top:18px;">Your Drafts</h4>
            </div>
            <button onclick="closeDraftModal()" style="margin-top:18px;background:#d9534f;">Close</button>
        </div>
    </div>

    <!-- Full Post Modal -->
    <div class="full-post-modal" id="fullPostModal">
        <div class="full-post-content" id="fullPostContent"></div>
    </div>

    <!-- Author/Admin Dashboard Modal -->
    <div class="dashboard-modal" id="dashboardModal">
        <div class="dashboard-modal-content" id="dashboardContent"></div>
    </div>

    <!-- Paused Author Overlay -->
    <div class="blur-overlay" id="pausedOverlay" style="display:none;">
        <div class="paused-warning">
            Your account is <b>paused</b>.<br>
            <span style="color:#b52b1b;">Contact the admin to have your account activated.</span>
        </div>
        <button onclick="openMessageToAdmin()" style="background:#007bff;color:#fff;">Message Admin</button>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Masaba Hope Center. All Rights Reserved.</p>
        <a href="privacy.html">Privacy Policy</a> | <a href="terms.html">Terms of Service</a>
    </footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
import { getDatabase, ref, push, get, remove, set, update, onValue } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-storage.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyC7B8c_s6x9vadzJqTV_iiGyGEoOMVSRls",
    authDomain: "masabahopecenter.firebaseapp.com",
    databaseURL: "https://masabahopecenter-default-rtdb.firebaseio.com",
    projectId: "masabahopecenter",
    storageBucket: "masabahopecenter.appspot.com",
    messagingSenderId: "862140344042",
    appId: "1:862140344042:web:a39262416ca525ab7a9993"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);
const auth = getAuth(app);

let currentUser = null;
let isAdmin = false;
let authorName = null;

// --- Utility: Slugify title for postId ---
function slugify(text) {
    return text.toString().toLowerCase()
        .replace(/\s+/g, '-')           // Replace spaces with -
        .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
        .replace(/\-\-+/g, '-')         // Replace multiple - with single -
        .replace(/^-+/, '')             // Trim - from start of text
        .replace(/-+$/, '');            // Trim - from end of text
}

// --- Modal helpers ---
window.openLoginModal = function() {
    document.getElementById('loginModal').style.display = 'flex';
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginError').textContent = '';
    showLoginTab();
};
window.showLoginTab = function() {
    document.getElementById('loginTab').style.display = '';
    document.getElementById('recruitTab').style.display = 'none';
};
window.showRecruitTab = function() {
    document.getElementById('loginTab').style.display = 'none';
    document.getElementById('recruitTab').style.display = '';
};
window.closeDraftModal = function() {
    document.getElementById('draftModal').style.display = 'none';
};
window.openDraftModal = function() {
    document.getElementById('draftModal').style.display = 'flex';
    loadAuthorDrafts();
};
window.openDashboardModal = async function() {
    if (!currentUser) return;
    await promptAuthorName();
    document.getElementById('dashboardModal').style.display = 'flex';
    if (isAdmin) {
        await renderAdminDashboard();
    } else {
        await renderAuthorDashboard();
    }
};
window.closeDashboardModal = function() {
    document.getElementById('dashboardModal').style.display = 'none';
};

// --- Prompt for author name after login (if not already set) ---
async function promptAuthorName() {
    authorName = localStorage.getItem('authorName');
    if (!authorName) {
        authorName = prompt("Enter your author name (as registered):");
        if (authorName) {
            localStorage.setItem('authorName', authorName);
        }
    }
}

// --- Login ---
window.login = async function() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    document.getElementById('loginError').textContent = '';
    if (!email.toLowerCase().includes('user') && !email.toLowerCase().includes('admin')) {
        document.getElementById('loginError').textContent = "Only registered authors and admins can login.";
        return;
    }
    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        isAdmin = email.toLowerCase().includes('admin');
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('logoutBtn').style.display = '';
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('dashboardBtn').style.display = '';
        await promptAuthorName();
        if (authorName) {
            loadAuthorDrafts();
        }
        await loadAllPosts(); // Load posts after login
    } catch (err) {
        document.getElementById('loginError').textContent = "Login failed. Check your credentials.";
    }
};

// --- Logout ---
window.logout = async function() {
    await signOut(auth);
    currentUser = null;
    isAdmin = false;
    authorName = null;
    localStorage.removeItem('authorName');
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('loginBtn').style.display = '';
    document.getElementById('dashboardBtn').style.display = 'none';
    document.getElementById('pausedOverlay').style.display = 'none';
    document.getElementById('draftPostList').innerHTML = '';
    await loadAllPosts(); // Reload posts as guest
};

// --- On Auth State Change ---
onAuthStateChanged(auth, async user => {
    if (user) {
        currentUser = user;
        document.getElementById('logoutBtn').style.display = '';
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('dashboardBtn').style.display = '';
        if (user.email && user.email.toLowerCase().includes('admin')) {
            isAdmin = true;
        } else {
            isAdmin = false;
            await promptAuthorName();
            if (authorName) loadAuthorDrafts();
        }
        await loadAllPosts();
    } else {
        currentUser = null;
        isAdmin = false;
        authorName = null;
        localStorage.removeItem('authorName');
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('loginBtn').style.display = '';
        document.getElementById('dashboardBtn').style.display = 'none';
        document.getElementById('pausedOverlay').style.display = 'none';
        document.getElementById('draftPostList').innerHTML = '';
        await loadAllPosts();
    }
});

// --- Load All Posts (featured on top, latest first, paginated) ---
let lastLoadedKey = null;
let postsPerPage = 20;
async function loadAllPosts(reset = true) {
    const postsContainer = document.getElementById('postsContainer');
    const featureSection = document.getElementById('featureSection');
    if (reset) {
        postsContainer.innerHTML = '';
        featureSection.innerHTML = '';
        lastLoadedKey = null;
    }
    // Fetch all posts (flattened)
    const postsSnap = await get(ref(db, 'posts'));
    let posts = [];
    if (postsSnap.exists()) {
        postsSnap.forEach(authorSnap => {
            authorSnap.forEach(postSnap => {
                let post = postSnap.val();
                if (typeof post !== "object" || post === null) return; // Defensive: skip invalid
                post.postId = postSnap.key;
                post.authorName = authorSnap.key;
                posts.push(post);
            });
        });
    }
    // Sort: featured first, then by date desc
    posts.sort((a, b) => {
        if (b.featured && !a.featured) return 1;
        if (a.featured && !b.featured) return -1;
        return (b.date || 0) - (a.date || 0);
    });
    // Pagination
    let startIdx = 0;
    if (lastLoadedKey) {
        startIdx = posts.findIndex(p => p.postId === lastLoadedKey) + 1;
    }
    const pagePosts = posts.slice(startIdx, startIdx + postsPerPage);
    if (pagePosts.length === 0 && reset) {
        postsContainer.innerHTML = '<div style="color:#888;">No posts found.</div>';
        return;
    }
    // Render featured post
    if (reset && pagePosts.length > 0 && pagePosts[0].featured) {
        featureSection.innerHTML = renderFeaturePost(pagePosts[0]);
        pagePosts.shift();
    }
    // Render posts
    pagePosts.forEach(post => {
        postsContainer.innerHTML += renderPostCard(post);
    });
    // Save last loaded key for pagination
    if (pagePosts.length > 0) {
        lastLoadedKey = pagePosts[pagePosts.length - 1].postId;
    }
    // Show/hide "Show More" button
    document.getElementById('expandOtherStoriesBtn').style.display = (startIdx + postsPerPage < posts.length) ? '' : 'none';
}
window.expandOtherStories = function() {
    loadAllPosts(false);
};

// --- Render Feature Post ---
function renderFeaturePost(post) {
    return `
    <div class="feature-section">
        <h2>${post.title}</h2>
        <div class="post-meta">By ${post.authorName} | ${new Date(post.date).toLocaleString()}</div>
        ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" style="width:100%;max-height:320px;object-fit:cover;border-radius:8px;margin:18px 0;">` : ''}
        <div class="feature-body">${post.body}</div>
        <button class="expand-btn" onclick="openFullPost('${post.authorName}','${post.postId}')">Read Full Story</button>
    </div>
    `;
}

// --- Render Post Card ---
function renderPostCard(post) {
    return `
    <div class="post-card" onclick="openFullPost('${post.authorName}','${post.postId}')">
        ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image">` : ''}
        <div class="post-content">
            <div class="post-title">${post.title}</div>
            <div class="post-meta">By ${post.authorName} | ${new Date(post.date).toLocaleString()}</div>
            <div class="post-highlight">${post.body.replace(/<[^>]+>/g, '').substring(0, 120)}${post.body.length > 120 ? '...' : ''}</div>
        </div>
    </div>
    `;
}

// --- Open Full Post Modal ---
window.openFullPost = async function(authorName, postId) {
    const postRef = ref(db, `posts/${authorName}/${postId}`);
    const postSnap = await get(postRef);
    if (!postSnap.exists()) return;
    const post = postSnap.val();
    post.postId = postId;
    post.authorName = authorName;
    let html = `
        <button class="exit-btn" onclick="closeFullPost()">&times;</button>
        <div class="full-post-title">${post.title}</div>
        <div class="full-post-meta">By ${post.authorName} | ${new Date(post.date).toLocaleString()}</div>
        ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image">` : ''}
        <div class="full-post-body">${post.body}</div>
        <div class="full-post-actions">
            <button onclick="reportPost('${authorName}','${postId}')">Report Post</button>
        </div>
        <div class="comments-section" id="commentsSection"></div>
    `;
    document.getElementById('fullPostContent').innerHTML = html;
    document.getElementById('fullPostModal').style.display = 'flex';
    await loadComments(authorName, postId);
};
window.closeFullPost = function() {
    document.getElementById('fullPostModal').style.display = 'none';
};

// --- Load Comments for a Post ---
async function loadComments(authorName, postId) {
    const commentsRef = ref(db, `posts/${authorName}/${postId}/comments`);
    const commentsSnap = await get(commentsRef);
    let comments = [];
    if (commentsSnap.exists()) {
        commentsSnap.forEach(child => {
            let c = child.val();
            c.commentId = child.key;
            comments.push(c);
        });
    }
    // Sort by date desc, show flagged/hidden for admin/author
    comments.sort((a, b) => (b.date || 0) - (a.date || 0));
    let html = `
        <div><b>Comments</b></div>
        <form class="comment-form" onsubmit="return submitComment('${authorName}','${postId}')">
            <input type="text" id="commentAuthor" placeholder="Your Name" required>
            <textarea id="commentBody" placeholder="Write a comment..." required></textarea>
            <button type="submit">Add Comment</button>
        </form>
        <div class="comment-list">
            ${comments.map(c => renderComment(c, authorName, postId)).join('')}
        </div>
    `;
    document.getElementById('commentsSection').innerHTML = html;
}

// --- Render a Comment (with replies) ---
function renderComment(comment, authorName, postId) {
    let flagged = comment.flagged ? 'flagged' : '';
    let hidden = comment.hidden ? 'hidden' : '';
    let actions = '';
    // Authors and admin can reply, report, and see flagged/hidden
    if (currentUser) {
        actions += `<button class="reply-btn" onclick="replyToComment('${authorName}','${postId}','${comment.commentId}')">Reply</button>`;
        actions += `<button class="flag-btn" onclick="reportComment('${authorName}','${postId}','${comment.commentId}')">Report</button>`;
    }
    if (isAdmin) {
        actions += `<button class="edit-btn" onclick="unhideComment('${authorName}','${postId}','${comment.commentId}')">${comment.hidden ? 'Unhide' : 'Hide'}</button>`;
        actions += `<button onclick="deleteComment('${authorName}','${postId}','${comment.commentId}')">Delete</button>`;
    }
    let repliesHtml = '';
    if (comment.replies) {
        repliesHtml = `<div class="reply-list">${Object.entries(comment.replies).map(([rid, r]) => `
            <div class="comment">
                <span class="comment-author">${r.author}</span>
                <span class="comment-date">${new Date(r.date).toLocaleString()}</span>
                <div class="comment-body">${r.body}</div>
            </div>
        `).join('')}</div>`;
    }
    return `
    <div class="comment ${flagged} ${hidden}">
        <span class="comment-author">${comment.author}</span>
        <span class="comment-date">${new Date(comment.date).toLocaleString()}</span>
        <div class="comment-body">${comment.body}</div>
        <div class="comment-actions">${actions}</div>
        ${comment.flagged ? `<div style="color:#d9534f;font-size:0.95em;">Flagged: ${comment.flagged.description}</div>` : ''}
        ${repliesHtml}
    </div>
    `;
}

// --- Submit Comment ---
window.submitComment = async function(authorName, postId) {
    event.preventDefault();
    const author = document.getElementById('commentAuthor').value.trim();
    const body = document.getElementById('commentBody').value.trim();
    if (!author || !body) return false;
    const comment = {
        author,
        body,
        date: Date.now(),
        hidden: false,
        flagged: null,
        replies: {}
    };
    const commentsRef = ref(db, `posts/${authorName}/${postId}/comments`);
    await push(commentsRef, comment);
    document.getElementById('commentAuthor').value = '';
    document.getElementById('commentBody').value = '';
    await loadComments(authorName, postId);
    return false;
};

// --- Reply to Comment ---
window.replyToComment = function(authorName, postId, commentId) {
    const reply = prompt("Enter your reply:");
    if (!reply) return;
    const replyObj = {
        author: authorName || "Anonymous",
        body: reply,
        date: Date.now()
    };
    const repliesRef = ref(db, `posts/${authorName}/${postId}/comments/${commentId}/replies`);
    push(repliesRef, replyObj).then(() => loadComments(authorName, postId));
};

// --- Report Post ---
window.reportPost = function(authorName, postId) {
    const description = prompt("Describe the issue with this post:");
    if (!description) return;
    const report = {
        reportedBy: authorName || "Anonymous",
        description,
        date: Date.now()
    };
    set(ref(db, `reports/posts/${postId}`), report);
    alert("Post reported to admin.");
};

// --- Report Comment ---
window.reportComment = function(authorName, postId, commentId) {
    const description = prompt("Describe the issue with this comment:");
    if (!description) return;
    const report = {
        reportedBy: authorName || "Anonymous",
        description,
        date: Date.now()
    };
    set(ref(db, `reports/comments/${postId}/${commentId}`), report);
    update(ref(db, `posts/${authorName}/${postId}/comments/${commentId}`), {
        flagged: report
    });
    alert("Comment reported to admin.");
};

// --- Admin: Unhide/Hide Comment ---
window.unhideComment = function(authorName, postId, commentId) {
    const commentRef = ref(db, `posts/${authorName}/${postId}/comments/${commentId}`);
    get(commentRef).then(snap => {
        if (snap.exists()) {
            const c = snap.val();
            update(commentRef, { hidden: !c.hidden });
            loadComments(authorName, postId);
        }
    });
};

// --- Admin: Delete Comment ---
window.deleteComment = function(authorName, postId, commentId) {
    if (!confirm("Delete this comment?")) return;
    remove(ref(db, `posts/${authorName}/${postId}/comments/${commentId}`)).then(() => {
        loadComments(authorName, postId);
    });
};
//--- Cloudinary Upload Helper ---
async function uploadImageToCloudinary(imageInput) {
    if (imageInput.files && imageInput.files[0]) {
        const file = imageInput.files[0];
        const url = "https://api.cloudinary.com/v1_1/dtpmufi7g/image/upload";
        const preset = "masaba blog";
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", preset);

        const res = await fetch(url, {
            method: "POST",
            body: formData
        });
        if (!res.ok) throw new Error("Image upload failed");
        const data = await res.json();
        return data.secure_url; // This is the image URL to store in Firebase
    }
    return "";
}
// --- Save Draft ---
async function saveDraft({ title, body, imageUrl, featured, draftId }) {
    if (!authorName) await promptAuthorName();
    if (!authorName) return alert("Author name is required.");
    const draftData = {
        title,
        body,
        imageUrl: imageUrl || "",
        author: authorName,
        featured: !!featured,
        date: Date.now()
    };
    document.getElementById('postForm').onsubmit = async function(e) {
    e.preventDefault();
    const title = document.getElementById('draftTitle').value.trim();
    const body = document.getElementById('draftBody').innerHTML.trim();
    const featured = document.getElementById('featurePost').checked;
    const imageInput = document.getElementById('draftImage');
    let imageUrl = await uploadImageToCloudinary(imageInput);

    let draftId = document.getElementById('postForm').getAttribute('data-edit-id');
    if (!draftId) draftId = slugify(title) + '-' + Date.now();

    await saveDraft({ title, body, imageUrl, featured, draftId });
    document.getElementById('postForm').reset();
    document.getElementById('postForm').removeAttribute('data-edit-id');
    loadAuthorDrafts();
};
    await set(ref(db, `drafts/${authorName}/${draftId}`), draftData);
    alert("Draft saved!");
    loadAuthorDrafts();
}
// --- Publish Post ---
async function publishPostDirect({ title, body, imageUrl, featured }) {
    if (!authorName) await promptAuthorName();
    if (!authorName) return alert("Author name is required.");
    const postId = slugify(title) + '-' + Date.now();
    const postData = {
        title,
        body,
        imageUrl: imageUrl || "",
        author: authorName,
        featured: !!featured,
        date: Date.now(),
        published: true
    };
    await set(ref(db, `posts/${authorName}/${postId}`), postData);

    // Delete draft if editing
    const draftId = document.getElementById('postForm').getAttribute('data-edit-id');
    if (draftId) {
        await remove(ref(db, `drafts/${authorName}/${draftId}`));
        document.getElementById('postForm').removeAttribute('data-edit-id');
    }

    alert("Post published!");
    document.getElementById('postForm').reset();
    closeDraftModal();
    loadAllPosts();
    loadAuthorDrafts();
}

// --- Load Author Drafts ---
async function loadAuthorDrafts() {
    if (!authorName) await promptAuthorName();
    if (!authorName) return;
    const draftsRef = ref(db, `drafts/${authorName}`);
    const snap = await get(draftsRef);
    const draftList = document.getElementById('draftPostList');
    let html = '<h4 style="margin-top:18px;">Your Drafts</h4>';
if (snap.exists()) {
    let found = false;
    snap.forEach(child => {
        const draft = child.val();
        html += `<div class="post-item">
            <span class="post-title">${draft.title}</span>
            <button onclick="editDraft('${child.key}')">Edit</button>
            <button onclick="deleteDraft('${child.key}')">Delete</button>
        </div>`;
        found = true;
    });
    if (!found) html += "<div>No drafts found.</div>";
} else {
    html += "<div>No drafts found.</div>";
}
draftList.innerHTML = html;
}
window.editDraft = async function(draftId) {
    const snap = await get(ref(db, `drafts/${authorName}/${draftId}`));
    if (snap.exists()) {
        const draft = snap.val();
        document.getElementById('draftTitle').value = draft.title;
        document.getElementById('draftBody').innerHTML = draft.body;
        document.getElementById('featurePost').checked = !!draft.featured;
        // Note: Image can't be loaded into <input type="file"> for security reasons.
        // Optionally, show a preview or ask user to re-upload if needed.
        document.getElementById('draftModal').style.display = 'flex';
        // Store the draftId for update
        document.getElementById('postForm').setAttribute('data-edit-id', draftId);
    }
};

window.deleteDraft = async function(draftId) {
    if (confirm("Delete this draft?")) {
        await remove(ref(db, `drafts/${authorName}/${draftId}`));
        loadAuthorDrafts();
    }
};

// --- Draft Form Handler ---
document.getElementById('postForm').onsubmit = async function(e) {
    e.preventDefault();
    const title = document.getElementById('draftTitle').value.trim();
    const body = document.getElementById('draftBody').innerHTML.trim();
    const featured = document.getElementById('featurePost').checked;
    const imageInput = document.getElementById('draftImage');
    let imageUrl = await uploadImageToCloudinary(imageInput);

    await saveDraft({ title, body, imageUrl, featured });
    document.getElementById('postForm').reset();
    loadAuthorDrafts();
};

document.getElementById('publishPostBtn').onclick = async function() {
    const title = document.getElementById('draftTitle').value.trim();
    const body = document.getElementById('draftBody').innerHTML.trim();
    const featured = document.getElementById('featurePost').checked;
    const imageInput = document.getElementById('draftImage');
    let imageUrl = await uploadImageToCloudinary(imageInput);

    await publishPostDirect({ title, body, imageUrl, featured });
};
// --- Author Dashboard ---
async function renderAuthorDashboard() {
    // Welcome message
    let welcomeHtml = `<div style="background:#e6f7ff;padding:12px 16px;border-radius:8px;margin-bottom:18px;">
        <b>Welcome back, ${authorName}!</b> We value your input to make this website better.<br>
        Please login first to resume your blogging and message fellow authors and request help from Admin.
    </div>`;
    // --- Add "Create New Post" button ---
    let createBtnHtml = `<button onclick="openDraftModal()" style="background:#28a745;color:#fff;margin-bottom:16px;">Create New Post</button>`;
    // List all authors
    const authorsSnap = await get(ref(db, 'authors'));
    let authorsHtml = '<h4>Other Authors</h4><ul>';
    if (authorsSnap.exists()) {
        authorsSnap.forEach(child => {
            const a = child.val();
            if (a.name !== authorName) {
                authorsHtml += `<li>${a.name} <button onclick="openAuthorChat('${a.name}')">Message</button></li>`;
            }
        });
    }
    authorsHtml += '</ul>';
    // List all posts (latest 20)
    const postsSnap = await get(ref(db, 'posts'));
    let posts = [];
    if (postsSnap.exists()) {
        postsSnap.forEach(authorSnap => {
            authorSnap.forEach(postSnap => {
                let post = postSnap.val();
                if (typeof post !== "object" || post === null) return;
                post.postId = postSnap.key;
                post.authorName = authorSnap.key;
                posts.push(post);
            });
        });
    }
    posts.sort((a, b) => (b.date || 0) - (a.date || 0));
    let postsHtml = '<h4>All Posts</h4><ul>';
    posts.slice(0, 20).forEach(post => {
        postsHtml += `<li>${post.title} by ${post.authorName} <button onclick="openFullPost('${post.authorName}','${post.postId}')">View</button></li>`;
    });
    postsHtml += '</ul>';
    // List all comments (latest 20)
    let comments = [];
    posts.forEach(post => {
        if (post.comments) {
            Object.entries(post.comments).forEach(([cid, c]) => {
                comments.push({ ...c, postTitle: post.title, postId: post.postId, authorName: post.authorName });
            });
        }
    });
    comments.sort((a, b) => (b.date || 0) - (a.date || 0));
    let commentsHtml = '<h4>Recent Comments</h4><ul>';
    comments.slice(0, 20).forEach(c => {
        commentsHtml += `<li>On <b>${c.postTitle}</b> by ${c.author}: ${c.body.substring(0, 40)} <button onclick="openFullPost('${c.authorName}','${c.postId}')">View</button></li>`;
    });
    commentsHtml += '</ul>';
    // List your drafts
    let draftsHtml = '<h4>Your Drafts</h4><ul>';
    const draftsRef = ref(db, `drafts/${authorName}`);
    const draftsSnap = await get(draftsRef);
    if (draftsSnap.exists()) {
        draftsSnap.forEach(child => {
            const draft = child.val();
            draftsHtml += `<li>${draft.title}</li>`;
        });
    }
    draftsHtml += '</ul>';
    // Render dashboard
    document.getElementById('dashboardContent').innerHTML = `
        <button onclick="closeDashboardModal()" style="float:right;background:#d9534f;">Close</button>
        ${welcomeHtml}
        ${createBtnHtml}
        ${authorsHtml}
        ${postsHtml}
        ${commentsHtml}
        ${draftsHtml}
    `;
}

// --- Author Messaging ---
window.openAuthorChat = function(otherAuthorName) {
    alert("Messaging between authors coming soon! (Implement as needed)");
    // You can implement a chat modal similar to admin chat, using messages/{author1_author2}
};

// --- Admin Dashboard (see all posts, drafts, comments, reports, manage authors, messages) ---
async function renderAdminDashboard() {
    // Fetch all posts
    const postsSnap = await get(ref(db, 'posts'));
    let postsHtml = '<h3>All Posts</h3><ul>';
    if (postsSnap.exists()) {
        postsSnap.forEach(authorSnap => {
            authorSnap.forEach(postSnap => {
                const post = postSnap.val();
                postsHtml += `<li>
                    <b>${post.title}</b> by ${authorSnap.key}
                    <button onclick="openFullPost('${authorSnap.key}','${postSnap.key}')">View</button>
                </li>`;
            });
        });
    } else {
        postsHtml += '<li>No posts found.</li>';
    }
    postsHtml += '</ul>';

    // Fetch reported comments
    const reportsSnap = await get(ref(db, 'reports/comments'));
    let reportsHtml = '<h3>Reported Comments</h3><ul>';
    if (reportsSnap.exists()) {
        reportsSnap.forEach(postIdSnap => {
            postIdSnap.forEach(commentSnap => {
                const report = commentSnap.val();
                reportsHtml += `<li>
                    <b>Post:</b> ${postIdSnap.key}, <b>Comment:</b> ${commentSnap.key}<br>
                    <b>Reason:</b> ${report.description}<br>
                    <small>Reported by: ${report.reportedBy || "Anonymous"} on ${new Date(report.date).toLocaleString()}</small>
                </li>`;
            });
        });
    } else {
        reportsHtml += '<li>No reported comments.</li>';
    }
    reportsHtml += '</ul>';

    // Fetch all authors
    const authorsSnap = await get(ref(db, 'authors'));
    let authorsHtml = '<h3>Authors</h3><ul>';
    if (authorsSnap.exists()) {
        authorsSnap.forEach(child => {
            const a = child.val();
            authorsHtml += `<li>${a.name || child.key} (${a.email || ''})</li>`;
        });
    } else {
        authorsHtml += '<li>No authors found.</li>';
    }
    authorsHtml += '</ul>';

    document.getElementById('dashboardContent').innerHTML = `
        <h2>Admin Dashboard</h2>
        <p>Welcome, Admin! Here you can manage posts, comments, authors, and review reports.</p>
        ${postsHtml}
        ${reportsHtml}
        ${authorsHtml}
        <button onclick="closeDashboardModal()" style="background:#d9534f;">Close</button>
    `;
}

// --- Initial load ---
loadAllPosts();

</script>
</body>
</html>
