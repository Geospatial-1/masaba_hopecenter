<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masaba Hope Center News</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.min.css">
    <style>
        body {
            font-family: 'Inter', 'Lato', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(120deg, #f9f9f9 60%, #e3f6fc 100%);
        }
        .navbar {
            background-color: #28a745;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .navbar-brand {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }
        .navbar-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .navbar-links a, .login-btn {
            background: white;
            color: #007bff;
            font-size: 1rem;
            font-weight: bold;
            padding: 8px 14px;
            border-radius: 4px;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .navbar-links a:hover, .login-btn:hover {
            background-color: #ffc107;
            color: #0056b3;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 32px 0 24px 0;
            text-align: center;
        }
        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin: 0;
        }
        .header p {
            font-size: 1.15rem;
            margin: 10px 0 0;
        }
        .container {
            max-width: 1100px;
            margin: 20px auto;
            padding: 0 12px;
        }
        /* DRAFT MODAL */
        .draft-modal {
            display: none;
            position: fixed;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.85);
            z-index: 4000;
            align-items: flex-start;
            justify-content: center;
            overflow-y: auto;
        }
        .draft-modal.active { display: flex; }
        .draft-modal-content {
            background: #fff;
            border-radius: 14px;
            padding: 38px 28px 28px 28px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            max-width: 700px;
            width: 98vw;
            margin: 40px auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .draft-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .draft-header h2 {
            margin: 0;
            font-size: 2rem;
            color: #007bff;
        }
        .draft-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .draft-item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 16px 14px;
            margin-bottom: 14px;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .draft-title {
            font-size: 1.15rem;
            font-weight: bold;
            color: #d9534f;
        }
        .draft-meta {
            color: #888;
            font-size: 0.98rem;
        }
        .draft-actions {
            display: flex;
            gap: 10px;
            margin-top: 6px;
        }
        .draft-actions button {
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 6px 16px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }
        .draft-actions button.delete-btn {
            background: #d9534f;
        }
        .draft-actions button.delete-btn:hover {
            background: #b52a1d;
        }
        .draft-actions button.update-btn {
            background: #ffc107;
            color: #222;
        }
        .draft-actions button.update-btn:hover {
            background: #ff9800;
            color: #fff;
        }
        .draft-actions button.publish-btn {
            background: #28a745;
        }
        .draft-actions button.publish-btn:hover {
            background: #1e7e34;
        }
        .draft-actions button.view-btn {
            background: #6c757d;
        }
        .draft-actions button.view-btn:hover {
            background: #343a40;
        }
        .draft-editor {
            margin-top: 18px;
            background: #f6f6f6;
            border-radius: 8px;
            padding: 18px;
        }
        .draft-editor input {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .draft-editor label {
            font-weight: bold;
            margin-bottom: 4px;
            display: block;
        }
        .draft-editor .editor-actions {
            display: flex;
            gap: 10px;
        }
        .close-draft-btn {
            background: #d9534f;
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 8px 22px;
            font-weight: bold;
            font-size: 1.08rem;
            cursor: pointer;
            margin-left: auto;
            transition: background 0.2s;
        }
        .close-draft-btn:hover { background: #b52a1d; }
        .draft-empty {
            color: #888;
            font-style: italic;
            margin: 24px 0;
            text-align: center;
        }
        .draft-editor .image-preview-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .draft-editor .image-preview-item {
            position: relative;
            display: inline-block;
        }
        .draft-editor .image-preview-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .draft-editor .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #d9534f;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 1rem;
            cursor: pointer;
        }
        /* Toolbar for formatting */
        .draft-toolbar {
            margin-bottom: 8px;
        }
        .draft-toolbar button {
            background: #f6f6f6;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 4px;
            padding: 4px 8px;
            font-size: 1rem;
            cursor: pointer;
        }
        .draft-toolbar button:hover {
            background: #e3e3e3;
        }
        /* Rich text area */
        #draftBodyInput {
            min-height: 120px;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 8px;
            background: #fff;
            margin-bottom: 10px;
        }
        /* Blog post card */
        .post-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            margin-bottom: 28px;
            padding: 22px 20px 18px 20px;
        }
        .post-title {
            font-size: 1.5rem;
            font-family: 'Playfair Display', serif;
            color: #007bff;
            margin: 0 0 8px 0;
        }
        .post-meta {
            color: #888;
            font-size: 0.98rem;
            margin-bottom: 10px;
        }
        .post-body {
            font-size: 1.13rem;
            color: #222;
            margin-bottom: 10px;
        }
        .post-body img {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
            display: block;
        }
        @media (max-width: 700px) {
            .draft-modal-content { padding: 14px 2vw; }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <span class="navbar-brand">Masaba Hope Center Blog</span>
        <div class="navbar-links">
            <a href="index.html">Home</a>
            <a href="about.html">About</a>
            <a href="programs.html">Programs</a>
            <a href="donate.html">Donate</a>
            <a href="blog.html">Blog</a>
            <a href="contact.html">Contact</a>
            <button class="login-btn" onclick="openLoginModal()">Login</button>
        </div>
    </nav>

    <!-- Blog Header -->
    <header class="header">
        <h1>Masaba News Updates</h1>
        <p>Stay updated with the latest news and stories</p>
    </header>

    <!-- Admin Actions Bar (for admin only) -->
    <div class="container" id="adminActionsBar" style="display:none;">
        <div class="admin-actions-bar">
            <button onclick="window.location.href='reported posts.html'">Reported Posts</button>
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Notification Bar for Reports -->
    <div class="container" id="notificationBar" style="display:none;">
        <div class="notification-bar">
            <span id="notificationText"></span>
            <button class="respond-btn" onclick="window.location.href='reported posts.html'">View Reports</button>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="container">
        <input type="text" id="searchInput" placeholder="Search posts by title..." style="width:100%;padding:10px 14px;font-size:1.1rem;border-radius:6px;border:1px solid #ccc;margin-bottom:18px;">
    </div>

    <!-- Feature Post Section -->
    <div class="container" id="featureSection"></div>

    <!-- Blog Posts -->
    <div class="container" id="postsContainer"></div>
    <div class="container" id="otherStoriesContainer" style="display:none;"></div>
    <button class="expand-btn" id="expandOtherStoriesBtn" style="display:none;" onclick="expandOtherStories()">Show More Stories</button>

    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <form class="login-modal-content" id="loginForm" autocomplete="on" onsubmit="return false;">
            <h2>Login</h2>
            <input type="email" id="loginEmail" placeholder="Email" required autocomplete="username">
            <input type="password" id="loginPassword" placeholder="Password" required autocomplete="current-password">
            <input type="text" id="loginDisplayName" placeholder="Your Name (for posts)" required>
            <button type="submit">Login</button>
            <div class="login-error" id="loginError"></div>
        </form>
    </div>

    <!-- Draft Modal (Enhanced, overlays blog, does not hide it) -->
    <div class="draft-modal" id="draftModal">
        <div class="draft-modal-content">
            <div class="draft-header">
                <h2>Drafts & Posts</h2>
                <button class="close-draft-btn" onclick="closeDraftModal()">Close</button>
            </div>
            <div>
                <b>Welcome, <span id="draftUserName"></span>!</b>
            </div>
            <div>
                <button onclick="openDraftEditor()" style="background:#28a745;color:#fff;padding:8px 18px;border-radius:6px;border:none;font-weight:bold;cursor:pointer;">+ New Draft</button>
            </div>
            <div id="draftListArea"></div>
            <div id="draftEditorArea" style="display:none;"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Masaba Hope Center. All Rights Reserved.</p>
        <a href="privacy.html">Privacy Policy</a> | <a href="terms.html">Terms of Service</a>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getDatabase, ref, push, get, remove, set, update } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-storage.js";

        // --- User Level Logic ---
        function getUserLevel(email) {
            if (!email) return null;
            if (email.endsWith('@masaba.co.ke')) {
                if (email.startsWith('admin')) return 'admin';
                if (email.startsWith('hopeuser')) return 'author';
            }
            return 'author';
        }

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyC7B8c_s6x9vadzJqTV_iiGyGEoOMVSRls",
            authDomain: "masabahopecenter.firebaseapp.com",
            databaseURL: "https://masabahopecenter-default-rtdb.firebaseio.com",
            projectId: "masabahopecenter",
            storageBucket: "masabahopecenter.appspot.com",
            messagingSenderId: "862140344042",
            appId: "1:862140344042:web:a39262416ca525ab7a9993"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        let currentUser = null;
        let userLevel = null;
        let displayName = '';
        let _allDrafts = [];
        let _allPosts = [];
        let _draftImages = [];
        let _draftBodyHtml = '';

        // --- Login Modal Logic ---
        window.openLoginModal = function() {
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('loginError').textContent = '';
        };
        window.logout = function() {
            signOut(auth);
            currentUser = null;
            userLevel = null;
            document.getElementById('adminActionsBar').style.display = 'none';
            closeDraftModal();
            document.getElementById('loginModal').classList.add('active');
        };

        function showDraftModalAfterLogin(user) {
            document.getElementById('draftModal').classList.add('active');
            document.getElementById('draftUserName').textContent = user?.displayName || user?.email || '';
            loadUserDraftsAndPosts();
        }
        window.closeDraftModal = function() {
            document.getElementById('draftModal').classList.remove('active');
            document.getElementById('draftEditorArea').style.display = 'none';
        };

        // Handle login form submit
        document.getElementById('loginForm').onsubmit = async function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const name = document.getElementById('loginDisplayName').value.trim();
            document.getElementById('loginError').textContent = '';
            try {
                const cred = await signInWithEmailAndPassword(auth, email, password);
                currentUser = cred.user;
                displayName = name;
                userLevel = getUserLevel(email);
                document.getElementById('loginModal').classList.remove('active');
                if (userLevel === 'admin') {
                    document.getElementById('adminActionsBar').style.display = '';
                } else {
                    document.getElementById('adminActionsBar').style.display = 'none';
                }
                showDraftModalAfterLogin(currentUser);
            } catch (err) {
                document.getElementById('loginError').textContent = "Invalid credentials or not authorized.";
            }
        };

        // Always show draft modal after login (even on page reload)
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                userLevel = getUserLevel(user.email);
                document.getElementById('loginModal').classList.remove('active');
                if (userLevel === 'admin') {
                    document.getElementById('adminActionsBar').style.display = '';
                } else {
                    document.getElementById('adminActionsBar').style.display = 'none';
                }
                showDraftModalAfterLogin(user);
            }
        });

        // --- Drafts & Posts Logic ---
        async function loadUserDraftsAndPosts() {
            const postsRef = ref(db, 'posts');
            const snapshot = await get(postsRef);
            _allDrafts = [];
            _allPosts = [];
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const post = { ...child.val(), key: child.key };
                    if (userLevel === 'admin') {
                        if (post.status === 'draft') _allDrafts.push(post);
                        if (post.status === 'published') _allPosts.push(post);
                    } else if (userLevel === 'author') {
                        if (post.level === 'author' && post.status === 'draft') _allDrafts.push(post);
                        if (post.level === 'author' && post.status === 'published') _allPosts.push(post);
                    }
                });
            }
            renderDraftList();
        }

        function renderDraftList() {
            const area = document.getElementById('draftListArea');
            let html = '';
            if (_allDrafts.length === 0 && _allPosts.length === 0) {
                html = `<div class="draft-empty">No drafts or posts found.</div>`;
            } else {
                if (_allDrafts.length > 0) {
                    html += `<h3>Drafts</h3><ul class="draft-list">`;
                    _allDrafts.forEach(draft => {
                        html += `<li class="draft-item">
                            <div class="draft-title">${draft.title || '<em>Untitled Draft</em>'}</div>
                            <div class="draft-meta">By ${draft.authorName || draft.authorEmail} (${draft.level || ''}) &middot; Last updated: ${draft.date || ''}</div>
                            <div class="draft-actions">
                                <button class="update-btn" onclick="window.editDraft('${draft.key}')">Edit</button>
                                <button class="publish-btn" onclick="window.publishDraft('${draft.key}')">Publish</button>
                                ${userLevel === 'admin' ? `<button class="delete-btn" onclick="window.deleteDraft('${draft.key}')">Delete</button>` : ''}
                            </div>
                        </li>`;
                    });
                    html += `</ul>`;
                }
                if (_allPosts.length > 0) {
                    html += `<h3>Published Posts</h3><ul class="draft-list">`;
                    _allPosts.forEach(post => {
                        html += `<li class="draft-item">
                            <div class="draft-title">${post.title}</div>
                            <div class="draft-meta">By ${post.authorName || post.authorEmail} (${post.level || ''}) &middot; Published: ${post.date || ''}</div>
                            <div class="draft-actions">
                                ${userLevel === 'admin' ? `<button class="update-btn" onclick="window.editDraft('${post.key}', true)">Update</button>` : ''}
                                <button class="view-btn" onclick="window.viewPost('${post.key}')">View</button>
                                ${userLevel === 'admin' ? `<button class="delete-btn" onclick="window.deleteDraft('${post.key}')">Delete</button>` : ''}
                            </div>
                        </li>`;
                    });
                    html += `</ul>`;
                }
            }
            area.innerHTML = html;
        }

        // --- Draft Editor with Rich Text and Multiple Images ---
        window.openDraftEditor = function() {
            showDraftEditor();
        };
        window.editDraft = function(key, isPublished = false) {
            const post = (isPublished ? _allPosts : _allDrafts).find(d => d.key === key);
            if (post) showDraftEditor(post, isPublished);
        };
        window.deleteDraft = async function(key) {
            if (!confirm("Are you sure you want to delete this draft/post?")) return;
            await remove(ref(db, 'posts/' + key));
            loadUserDraftsAndPosts();
        };
        function showDraftEditor(post = {}, isPublished = false) {
            _draftImages = Array.isArray(post.images) ? [...post.images] : [];
            _draftBodyHtml = post.body || '';
            const area = document.getElementById('draftEditorArea');
            area.style.display = '';
            area.innerHTML = `
                <div class="draft-editor">
                    <label>Title</label>
                    <input id="draftTitleInput" value="${post.title || ''}" placeholder="Enter title">
                    <label>Your Name (will show as author)</label>
                    <input id="draftAuthorNameInput" value="${post.authorName || displayName || currentUser?.displayName || ''}" placeholder="Enter your name">
                    <label>Body</label>
                    <div class="draft-toolbar">
                        <button type="button" onclick="window.format('bold')"><b>B</b></button>
                        <button type="button" onclick="window.format('italic')"><i>I</i></button>
                        <button type="button" onclick="window.format('underline')"><u>U</u></button>
                        <button type="button" onclick="window.format('insertUnorderedList')">&#8226; List</button>
                        <button type="button" onclick="window.format('insertOrderedList')">1. List</button>
                        <button type="button" onclick="window.triggerDraftImageInput()">ðŸ“· Image</button>
                    </div>
                    <div id="draftBodyInput" contenteditable="true" style="min-height:120px;border:1px solid #ccc;border-radius:5px;padding:8px;background:#fff;margin-bottom:10px;">${_draftBodyHtml}</div>
                    <input type="file" id="draftImageInput" accept="image/*" multiple style="display:none;">
                    <div class="image-preview-list" id="imagePreviewList"></div>
                    <div class="editor-actions">
                        <button type="button" onclick="window.saveDraft('${post.key || ''}', ${isPublished})">Save</button>
                        ${!isPublished ? `<button type="button" onclick="window.saveDraft('${post.key || ''}', true)">Publish</button>` : ''}
                        <button type="button" onclick="window.closeDraftEditor()">Cancel</button>
                    </div>
                </div>
            `;
            renderImagePreview();
            document.getElementById('draftImageInput').addEventListener('change', handleImageUpload);
            document.getElementById('draftBodyInput').addEventListener('input', () => {
                _draftBodyHtml = document.getElementById('draftBodyInput').innerHTML;
            });
        }
        window.format = function(cmd) {
            document.execCommand(cmd, false, null);
        };
        window.triggerDraftImageInput = function() {
            document.getElementById('draftImageInput').click();
        };
        async function handleImageUpload(e) {
            const files = Array.from(e.target.files);
            for (const file of files) {
                const storageRef = sRef(storage, 'post-images/' + Date.now() + '_' + file.name);
                await uploadBytes(storageRef, file);
                const url = await getDownloadURL(storageRef);
                _draftImages.push({ url, name: file.name, storagePath: storageRef.fullPath });
                insertImageAtCursor(url);
            }
            renderImagePreview();
        }
        function insertImageAtCursor(url) {
            const editor = document.getElementById('draftBodyInput');
            const img = document.createElement('img');
            img.src = url;
            img.style.maxWidth = '100%';
            img.style.borderRadius = '6px';
            img.style.margin = '8px 0';
            img.setAttribute('data-draft-img', url);
            const sel = window.getSelection();
            if (!sel.rangeCount) {
                editor.appendChild(img);
            } else {
                const range = sel.getRangeAt(0);
                range.collapse(false);
                range.insertNode(img);
                range.setStartAfter(img);
                sel.removeAllRanges();
                sel.addRange(range);
            }
            _draftBodyHtml = editor.innerHTML;
        }
        function renderImagePreview() {
            const list = document.getElementById('imagePreviewList');
            if (!list) return;
            list.innerHTML = _draftImages.map((img, idx) => `
                <div class="image-preview-item">
                    <img src="${img.url}" alt="Image">
                    <button class="remove-image-btn" onclick="window.removeDraftImage(${idx})">&times;</button>
                </div>
            `).join('');
        }
        window.removeDraftImage = function(idx) {
            const img = _draftImages[idx];
            _draftImages.splice(idx, 1);
            const editor = document.getElementById('draftBodyInput');
            if (editor) {
                editor.innerHTML = editor.innerHTML.replace(new RegExp(`<img[^>]+src=["']${img.url}["'][^>]*>`, 'g'), '');
                _draftBodyHtml = editor.innerHTML;
            }
            renderImagePreview();
        };
        window.saveDraft = async function(key, isPublished) {
            const title = document.getElementById('draftTitleInput').value.trim();
            const body = document.getElementById('draftBodyInput').innerHTML.trim();
            const authorName = document.getElementById('draftAuthorNameInput').value.trim() || currentUser.email;
            const now = new Date().toISOString().slice(0, 16).replace('T', ' ');
            if (!title || !body) { alert('Title and body required.'); return; }
            const postData = {
                title,
                body,
                date: now,
                status: isPublished ? 'published' : 'draft',
                authorName,
                authorEmail: currentUser.email,
                level: userLevel,
                images: _draftImages
            };
            if (key) {
                await update(ref(db, 'posts/' + key), postData);
            } else {
                await push(ref(db, 'posts'), postData);
            }
            document.getElementById('draftEditorArea').style.display = 'none';
            loadUserDraftsAndPosts();
        };
        window.publishDraft = async function(key) {
            if (!key) { alert('Save the draft first.'); return; }
            await update(ref(db, 'posts/' + key), {
                status: 'published',
                date: new Date().toISOString().slice(0, 16).replace('T', ' ')
            });
            document.getElementById('draftEditorArea').style.display = 'none';
            loadUserDraftsAndPosts();
        };
        window.closeDraftEditor = function() {
            document.getElementById('draftEditorArea').style.display = 'none';
        };

        window.viewPost = function(key) {
            alert('View post: ' + key + '\n(You can implement a preview or redirect here.)');
        };

        // --- Modal Close on Outside Click ---
        window.onclick = function(event) {
            if (event.target.classList.contains('login-modal')) event.target.classList.remove('active');
            if (event.target.classList.contains('draft-modal')) closeDraftModal();
        };

        // --- PUBLIC BLOG: Load and Render Published Posts ---
        async function loadAndRenderPublishedPosts() {
            const postsRef = ref(db, 'posts');
            const snapshot = await get(postsRef);
            let posts = [];
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const post = { ...child.val(), key: child.key };
                    if (post.status === 'published') posts.push(post);
                });
            }
            posts.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            renderPublishedPosts(posts);
        }

        function renderPublishedPosts(posts) {
            const container = document.getElementById('postsContainer');
            if (!container) return;
            if (!posts.length) {
                container.innerHTML = `<div style="color:#888;text-align:center;margin:40px 0;">No posts yet.</div>`;
                return;
            }
            container.innerHTML = posts.map(post => `
                <div class="post-card">
                    <div class="post-title">${post.title || ''}</div>
                    <div class="post-meta">By ${post.authorName || post.authorEmail} (${post.level || ''}) &middot; ${post.date || ''}</div>
                    <div class="post-body">${post.body || ''}</div>
                </div>
            `).join('');
        }

        // --- Search Functionality ---
        document.getElementById('searchInput').addEventListener('input', async function() {
            const query = this.value.trim().toLowerCase();
            const postsRef = ref(db, 'posts');
            const snapshot = await get(postsRef);
            let posts = [];
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const post = { ...child.val(), key: child.key };
                    if (post.status === 'published') posts.push(post);
                });
            }
            if (query) {
                posts = posts.filter(post => (post.title || '').toLowerCase().includes(query));
            }
            posts.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
            renderPublishedPosts(posts);
        });

        // --- Initial Load: Show published posts to everyone ---
        loadAndRenderPublishedPosts();

    </script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.min.js" type="module"></script>
</body>
</html>
